{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="text-center text-primary mb-4">Polls</h1>

    <!-- Button to trigger the modal for adding a new poll -->
    <button type="button" class="btn btn-success mb-3 shadow-sm" data-bs-toggle="modal" data-bs-target="#addPollModal">
        <i class="bi bi-plus-lg"></i> Add New Poll
    </button>

    <!-- Poll Cards Display -->
    <div class="row row-cols-1 row-cols-md-3 g-4">
        {% for poll in all_polls %}
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title">{{ poll['question'] }}</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('polls.polls_home') }}">
                        <input type="hidden" name="poll_id" value="{{ poll['poll_id'] }}">
                        <div class="mb-3">
                            <label for="optionsDropdown" class="form-label">Select Option</label>
                            <select class="form-select" id="optionsDropdown" name="selected_option" required>
                                {% for option in poll['options'] %}
                                <option value="{{ option['option_id'] }}">{{ option['poll_option'] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success mt-2 shadow-sm">Vote</button>
                    </form>
                </div>
                <div class="card-footer">
                    <ul>
                        {% for option in poll['options'] %}
                        <li>{{ option['poll_option'] }}: {{ option['votes'] }} votes</li>
                        {% endfor %}
                    </ul>
                    <!-- Edit and Delete buttons -->
                    <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editPollModal" data-poll-id="{{ poll['poll_id'] }}" data-poll-question="{{ poll['question'] }}" data-poll-options="{{ poll['options']|tojson }}">
                        Edit
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deletePollModal" data-poll-id="{{ poll['poll_id'] }}">
                        Delete
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add Poll Modal -->
<div class="modal fade" id="addPollModal" tabindex="-1" aria-labelledby="addPollModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="addPollModalLabel">Create a New Poll</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('polls.add_poll') }}">
                <div class="modal-body text-dark">
                    <div class="mb-3">
                        <label for="question" class="form-label">Poll Question</label>
                        <input type="text" class="form-control" name="question" required>
                    </div>

                    <!-- Dynamic Options -->
                    <div class="mb-3" id="options-container">
                        <label for="options" class="form-label">Poll Options</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" name="options[]" placeholder="Option 1" required>
                        </div>
                    </div>

                    <!-- Add Option Button -->
                    <button type="button" class="btn btn-secondary" id="add-option-btn">Add Option</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Poll</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Poll Modal -->
<div class="modal fade" id="editPollModal" tabindex="-1" aria-labelledby="editPollModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editPollModalLabel">Edit Poll</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('polls.edit_poll') }}">
                <div class="modal-body text-dark">
                    <input type="hidden" name="poll_id" id="editPollId">
                    <div class="mb-3">
                        <label for="editQuestion" class="form-label">Poll Question</label>
                        <input type="text" class="form-control" name="question" id="editQuestion" required>
                    </div>

                    <!-- Dynamic Options -->
                    <div class="mb-3" id="editOptions-container">
                        <label for="editOptions" class="form-label">Poll Options</label>
                        <!-- Options will be dynamically populated here -->
                    </div>

                    <!-- Add Option Button -->
                    <button type="button" class="btn btn-secondary" id="edit-add-option-btn">Add Option</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Poll Modal -->
<div class="modal fade" id="deletePollModal" tabindex="-1" aria-labelledby="deletePollModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deletePollModalLabel">Delete Poll</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-dark">
                <p>Are you sure you want to delete this poll?</p>
                <form method="POST" action="{{ url_for('polls.delete_poll') }}">
                    <input type="hidden" name="poll_id" id="deletePollId">
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete Poll</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        let optionCount = 1; // Start with one option for adding new polls
        const optionsContainer = document.getElementById("options-container");
        const editOptionsContainer = document.getElementById("editOptions-container");

        // Add Option Button for new Poll
        const addOption = () => {
            optionCount++;
            const newOptionDiv = document.createElement("div");
            newOptionDiv.classList.add("input-group", "mb-2");
            newOptionDiv.id = "option" + optionCount;

            const newInput = document.createElement("input");
            newInput.type = "text";
            newInput.classList.add("form-control");
            newInput.name = "options[]";
            newInput.placeholder = "Option " + optionCount;
            newOptionDiv.appendChild(newInput);

            optionsContainer.appendChild(newOptionDiv);
        };

        // Edit Poll Modal
        const editPollModal = document.getElementById("editPollModal");
        editPollModal.addEventListener("show.bs.modal", function(event) {
            const button = event.relatedTarget;
            const pollId = button.getAttribute("data-poll-id");
            const pollQuestion = button.getAttribute("data-poll-question");
            const pollOptions = JSON.parse(button.getAttribute("data-poll-options"));

            const editPollId = document.getElementById("editPollId");
            const editQuestion = document.getElementById("editQuestion");

            editPollId.value = pollId;
            editQuestion.value = pollQuestion;

            // Clear existing options
            editOptionsContainer.innerHTML = '';
            optionCount = 0; // Reset option count

            pollOptions.forEach(option => {
                optionCount++;
                const optionDiv = document.createElement("div");
                optionDiv.classList.add("input-group", "mb-2");

                const optionInput = document.createElement("input");
                optionInput.type = "text";
                optionInput.classList.add("form-control");
                optionInput.name = "options[]";
                optionInput.value = option.poll_option;
                optionDiv.appendChild(optionInput);

                editOptionsContainer.appendChild(optionDiv);
            });
        });

        // Add Option Button for Editing Poll
        const editAddOptionButton = document.getElementById("edit-add-option-btn");
        editAddOptionButton.addEventListener("click", () => {
            optionCount++;
            const newOptionDiv = document.createElement("div");
            newOptionDiv.classList.add("input-group", "mb-2");

            const newInput = document.createElement("input");
            newInput.type = "text";
            newInput.classList.add("form-control");
            newInput.name = "options[]";
            newInput.placeholder = "Option " + optionCount;
            newOptionDiv.appendChild(newInput);

            editOptionsContainer.appendChild(newOptionDiv);
        });

        // Delete Poll Modal
        const deletePollModal = document.getElementById("deletePollModal");
        deletePollModal.addEventListener("show.bs.modal", function(event) {
            const button = event.relatedTarget;
            const pollId = button.getAttribute("data-poll-id");
            document.getElementById("deletePollId").value = pollId;
        });

        // Add Option Functionality
        const addOptionButton = document.getElementById("add-option-btn");
        addOptionButton.addEventListener("click", addOption);
    });
</script>

{% endblock %}
















